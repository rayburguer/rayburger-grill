import React, { useState, useEffect, useCallback } from 'react';
import { Loader2 } from 'lucide-react';
import Modal from '../ui/Modal';
import { User } from '../../types';
import { calculateLoyaltyTier, normalizePhone, getDeviceFingerprint } from '../../utils/helpers';
import { WELCOME_BONUS_USD } from '../../config/constants';

interface RegisterModalProps {
    isOpen: boolean;
    onClose: () => void;
    onRegister: (newUser: User) => void;
    registeredUsers: User[];

    onOpenLogin: () => void;
    role?: string;
    initialReferralCode?: string;
}

const COUNTRY_PREFIXES = [
    { code: '58', country: 'Venezuela', flag: 'ðŸ‡»ðŸ‡ª' },
    { code: '57', country: 'Colombia', flag: 'ðŸ‡¨ðŸ‡´' },
    { code: '1', country: 'USA/CanadÃ¡', flag: 'ðŸ‡ºðŸ‡¸' },
    { code: '34', country: 'EspaÃ±a', flag: 'ðŸ‡ªðŸ‡¸' },
    { code: '56', country: 'Chile', flag: 'ðŸ‡¨ðŸ‡±' },
    { code: '593', country: 'Ecuador', flag: 'ðŸ‡ªðŸ‡¨' },
    { code: '51', country: 'PerÃº', flag: 'ðŸ‡µðŸ‡ª' },
    { code: '54', country: 'Argentina', flag: 'ðŸ‡¦ðŸ‡·' },
];

const RegisterModal: React.FC<RegisterModalProps> = ({ isOpen, onClose, onRegister, registeredUsers = [], onOpenLogin, initialReferralCode }) => {
    const [name, setName] = useState<string>('');
    const [lastName, setLastName] = useState<string>('');
    const [phonePrefix, setPhonePrefix] = useState<string>('58');
    const [phone, setPhone] = useState<string>('');
    const [password, setPassword] = useState<string>('');
    const [birthDate, setBirthDate] = useState<string>('');
    const [referrerCode, setReferrerCode] = useState<string>(initialReferralCode || '');

    const [isLoading, setIsLoading] = useState(false);

    // Errors
    const [phoneError, setPhoneError] = useState<string>('');
    const [passwordError, setPasswordError] = useState<string>('');
    const [referrerError, setReferrerError] = useState<string>('');

    // Referral code validation
    const handleReferralCodeChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const value = e.target.value.trim();
        setReferrerCode(value);

        if (value.length === 0) {
            setReferrerError('');
        } else {
            const codeExists = registeredUsers.some(u =>
                u.referralCode.toLowerCase() === value.toLowerCase()
            );
            const isVIPCode = ['VIP_RAY', 'RAYVIP'].includes(value.toUpperCase());
            const isFundadorCode = value.toUpperCase() === 'FUNDADOR';

            if (codeExists) {
                setReferrerError('âœ“ CÃ³digo vÃ¡lido');
            } else if (isFundadorCode) {
                setReferrerError('âœ“ CÃ³digo FUNDADOR Activo (3x Puntos)');
            } else if (isVIPCode) {
                setReferrerError('âœ“ CÃ³digo Promo Activo (2x Puntos)');
            } else {
                setReferrerError('âœ— CÃ³digo no encontrado');
            }
        }
    }, [registeredUsers]);

    const handlePhoneChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const value = e.target.value.replace(/\D/g, '');
        setPhone(value);

        if (value.length > 0 && value.length < 10) {
            setPhoneError('El nÃºmero debe tener al menos 10 dÃ­gitos.');
        } else {
            setPhoneError('');
        }
    }, []);

    const handlePasswordChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const value = e.target.value;
        setPassword(value);
        if (value.length > 0 && value.length < 4) {
            setPasswordError('MÃ­nimo 4 caracteres.');
        } else {
            setPasswordError('');
        }
    }, []);

    const isFormValid = phone.length >= 10 && password.length >= 4 && !phoneError && !passwordError && (referrerError === '' || referrerError.startsWith('âœ“'));

    const handleSubmit = useCallback(async (e: React.FormEvent) => {
        e.preventDefault();

        if (!isFormValid || isLoading) return;

        // Anti-Fraud check: Complete normalized phone
        const fullNormalizedPhone = phonePrefix + normalizePhone(phone);

        if (registeredUsers.some(u => normalizePhone(u.phone) === normalizePhone(phone) && u.phone.includes(phonePrefix))) {
            setPhoneError('ðŸš« Este nÃºmero ya estÃ¡ registrado.');
            return;
        }

        setIsLoading(true);
        await new Promise(resolve => setTimeout(resolve, 800));

        const newReferralCode = `RB-${Math.random().toString(36).substring(2, 9).toUpperCase()}`;
        const autoGeneratedEmail = `${fullNormalizedPhone}@rayburger.app`;

        const newUser: User = {
            email: autoGeneratedEmail,
            name: name.trim() || 'Amante de Burger',
            lastName: lastName.trim() || undefined,
            phone: fullNormalizedPhone,
            passwordHash: password,
            referralCode: newReferralCode,
            referredByCode: referrerCode || undefined,
            points: 50,
            loyaltyTier: calculateLoyaltyTier(0),
            walletBalance_usd: WELCOME_BONUS_USD,
            lifetimeSpending_usd: 0,
            orders: [],
            birthDate: birthDate || undefined,
            registrationDate: Date.now(),
            registeredVia: 'web',
            role: 'customer',
            nextPurchaseMultiplier: referrerCode?.toUpperCase() === 'FUNDADOR' ? 3 : (referrerCode ? 2 : 1),
            // Security: Device Fingerprint (stored in meta or custom field if needed)
            // For now we use the phone as primary unique key in Supabase
        };

        try {
            onRegister(newUser);
            setName('');
            setPhone('');
            setPassword('');
            setReferrerCode('');
        } catch (error) {
            console.error("Register error", error);
        } finally {
            setIsLoading(false);
        }

    }, [isFormValid, isLoading, name, phone, phonePrefix, password, referrerCode, onRegister, registeredUsers]);

    useEffect(() => {
        if (!isOpen) {
            setName('');
            setLastName('');
            setPhone('');
            setPassword('');
            setBirthDate('');
            setReferrerCode(initialReferralCode || '');
            setPhoneError('');
            setPasswordError('');
            setReferrerError('');
        } else {
            if (initialReferralCode) {
                setReferrerCode(initialReferralCode);
                const codeExists = registeredUsers?.some(u => u.referralCode?.toLowerCase() === initialReferralCode.toLowerCase());
                if (codeExists) setReferrerError('âœ“ CÃ³digo vÃ¡lido (desde enlace)');
            }
        }
    }, [isOpen, initialReferralCode, registeredUsers]);

    const handleLoginRedirect = useCallback(() => {
        onClose();
        onOpenLogin();
    }, [onClose, onOpenLogin]);


    return (
        <Modal isOpen={isOpen} onClose={onClose} title="Ãšnete al Club RayBurger">
            <form onSubmit={handleSubmit} className="space-y-4">

                {/* Phone Field */}
                <div>
                    <label className="block text-white text-lg font-semibold mb-2">
                        WhatsApp Internacional <span className="text-red-500">*</span>
                    </label>
                    <div className="flex gap-2">
                        <select
                            value={phonePrefix}
                            onChange={(e) => setPhonePrefix(e.target.value)}
                            className="bg-gray-800 text-white border-2 border-gray-600 rounded-md px-2 py-3 focus:border-orange-500 transition-all text-sm outline-none"
                        >
                            {COUNTRY_PREFIXES.map(p => (
                                <option key={p.code} value={p.code}>{p.flag} +{p.code}</option>
                            ))}
                        </select>
                        <input
                            type="tel"
                            placeholder="NÃºmero (10 dÃ­gitos)"
                            value={phone}
                            onChange={handlePhoneChange}
                            required
                            className={`flex-1 px-4 py-3 rounded-md bg-gray-700 text-white border-2 ${phoneError ? 'border-red-500' : 'border-gray-600'} focus:border-orange-500 transition-all placeholder-gray-400 text-lg outline-none`}
                        />
                    </div>
                    {phoneError && (
                        <p className="text-red-500 text-sm mt-1 flex items-center">
                            {phoneError}
                        </p>
                    )}
                </div>

                {/* Password Field */}
                <div>
                    <label htmlFor="registerPassword" className="block text-white text-lg font-semibold mb-2">
                        Clave secreta <span className="text-red-500">*</span>
                    </label>
                    <input
                        id="registerPassword"
                        type="password"
                        placeholder="Algo que recuerdes"
                        value={password}
                        onChange={handlePasswordChange}
                        required
                        minLength={4}
                        className={`w-full px-4 py-3 rounded-md bg-gray-700 text-white border-2 ${passwordError ? 'border-red-500' : 'border-gray-600'} focus:border-orange-500 transition-all placeholder-gray-400 text-lg outline-none`}
                    />
                    {passwordError && <p className="text-red-500 text-sm mt-1">{passwordError}</p>}
                </div>

                {/* Info Fields */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div>
                        <label className="block text-white text-xs mb-1 uppercase font-bold tracking-wider">Nombre</label>
                        <input
                            type="text"
                            placeholder="Ej: Juan"
                            value={name}
                            onChange={(e) => setName(e.target.value)}
                            className="w-full px-4 py-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:border-orange-500 outline-none"
                        />
                    </div>
                    <div>
                        <label className="block text-white text-xs mb-1 uppercase font-bold tracking-wider">Apellido</label>
                        <input
                            type="text"
                            placeholder="Ej: PÃ©rez"
                            value={lastName}
                            onChange={(e) => setLastName(e.target.value)}
                            className="w-full px-4 py-2 rounded-md bg-gray-700 text-white border border-gray-600 focus:border-orange-500 outline-none"
                        />
                    </div>
                </div>

                {/* Referrer */}
                <div className="mt-2">
                    <label className="block text-white text-sm mb-1 uppercase font-bold tracking-wider opacity-60">Â¿Tienes cÃ³digo de referido?</label>
                    <input
                        type="text"
                        placeholder="PÃ©galo aquÃ­"
                        value={referrerCode}
                        onChange={handleReferralCodeChange}
                        className={`w-full px-4 py-2 rounded-md bg-gray-700 text-white border ${referrerError.startsWith('âœ“') ? 'border-green-500' : referrerError.startsWith('âœ—') ? 'border-red-500' : 'border-gray-600'} focus:border-orange-500 outline-none transition-colors`}
                    />
                    {referrerError && (
                        <p className={`text-sm mt-1 ${referrerError.startsWith('âœ“') ? 'text-green-400' : 'text-red-400'}`}>
                            {referrerError}
                        </p>
                    )}
                </div>

                <button
                    type="submit"
                    disabled={!isFormValid || isLoading}
                    className={`w-full mt-6 py-4 rounded-full text-lg font-black uppercase tracking-widest transition-all ${isFormValid && !isLoading ? 'bg-orange-600 hover:bg-orange-700 text-white shadow-xl active:scale-95' : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        }`}
                >
                    {isLoading ? <Loader2 className="w-6 h-6 animate-spin mx-auto" /> : 'Â¡Registrarme! ðŸš€'}
                </button>
            </form>
            <p className="text-gray-400 text-center mt-6 text-sm">
                Â¿Ya eres parte?{' '}
                <button type="button" onClick={handleLoginRedirect} className="text-orange-400 hover:underline font-bold">
                    Entra aquÃ­
                </button>
            </p>
        </Modal>
    );
};

export default RegisterModal;
